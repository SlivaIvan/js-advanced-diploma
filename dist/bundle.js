(()=>{"use strict";function e(e,t){const a=[];for(let i=1;i<=t&&e%8!=0&&(a.push(e-i),(e-i)%8!=0);i+=1);for(let i=1;i<=t&&(e+1)%8!=0&&(a.push(e+i),(e+i+1)%8!=0);i+=1);for(let i=1;i<=t;i+=1){const t=8*i;if(e-t<0)break;a.push(e-t)}for(let i=1;i<=t;i+=1){const t=8*i;if(e+t>64)break;a.push(e+t)}for(let i=1;i<=t&&e%8!=0;i+=1){const t=e-i,s=8*i;if(t-s<0)break;if(a.push(t-s),(e-i)%8==0)break}for(let i=1;i<=t&&e%8!=0;i+=1){const t=e-i,s=8*i;if(t+s>64)break;if(a.push(t+s),(e-i)%8==0)break}for(let i=1;i<=t&&(e+1)%8!=0;i+=1){const t=e+i,s=8*i;if(t-s<0)break;if(a.push(t-s),(e+i+1)%8==0)break}for(let i=1;i<=t&&(e+1)%8!=0;i+=1){const t=e+i,s=8*i;if(t+s>64)break;if(a.push(t+s),(e+i+1)%8==0)break}return a}function t(e,t){const a=[];console.log(e);for(let i=1;i<=t&&e%8!=0&&(a.push(e-i),(e-i)%8!=0);i+=1);for(let i=1;i<=t&&(e+1)%8!=0&&(a.push(e+i),(e+i+1)%8!=0);i+=1);for(let i=1;i<=t;i+=1){const t=8*i;if(e-t<0)break;a.push(e-t)}for(let i=1;i<=t;i+=1){const t=8*i;if(e+t>64)break;a.push(e+t)}for(let i=1;i<=t&&e%8!=0;i+=1)for(let s=1;s<=t;s+=1){const t=e-s,r=8*i;if(t-r<0)break;if(a.push(t-r),(e-s)%8==0)break}for(let i=1;i<=t&&e%8!=0;i+=1)for(let s=1;s<=t;s+=1){const t=e-s,r=8*i;if(t+r>64)break;if(a.push(t+r),(e-s)%8==0)break}for(let i=1;i<=t&&(e+1)%8!=0;i+=1)for(let s=1;s<=t;s+=1){const t=e+s,r=8*i;if(t-r<0)break;if(a.push(t-r),(e+s+1)%8==0)break}for(let i=1;i<=t&&(e+1)%8!=0;i+=1)for(let s=1;s<=t;s+=1){const t=e+s,r=8*i;if(t+r>64)break;if(a.push(t+r),(e+s+1)%8==0)break}return a}class a{constructor(){this.boardSize=8,this.container=null,this.boardEl=null,this.cells=[],this.cellClickListeners=[],this.cellEnterListeners=[],this.cellLeaveListeners=[],this.newGameListeners=[],this.saveGameListeners=[],this.loadGameListeners=[]}bindToDOM(e){if(!(e instanceof HTMLElement))throw new Error("container is not HTMLElement");this.container=e}drawUi(e){this.checkBinding(),this.container.innerHTML='\n      <div class="controls">\n        <button data-id="action-restart" class="btn">New Game</button>\n        <button data-id="action-save" class="btn">Save Game</button>\n        <button data-id="action-load" class="btn">Load Game</button>\n      </div>\n      <div class="board-container">\n        <div data-id="board" class="board"></div>\n      </div>\n    ',this.newGameEl=this.container.querySelector("[data-id=action-restart]"),this.saveGameEl=this.container.querySelector("[data-id=action-save]"),this.loadGameEl=this.container.querySelector("[data-id=action-load]"),this.newGameEl.addEventListener("click",(e=>this.onNewGameClick(e))),this.saveGameEl.addEventListener("click",(e=>this.onSaveGameClick(e))),this.loadGameEl.addEventListener("click",(e=>this.onLoadGameClick(e))),this.boardEl=this.container.querySelector("[data-id=board]"),this.boardEl.classList.add(e);for(let e=0;e<this.boardSize**2;e+=1){const i=document.createElement("div");i.classList.add("cell","map-tile","map-tile-"+(t=e,a=this.boardSize,0===t?"top-left":t===a-1?"top-right":t>0&&t<a-1?"top":t===a*a-1?"bottom-right":t===a*a-a?"bottom-left":t>a*a-a&&t<a*a-1?"bottom":t%a==0?"left":(t+1)%a==0?"right":"center")),i.addEventListener("mouseenter",(e=>this.onCellEnter(e))),i.addEventListener("mouseleave",(e=>this.onCellLeave(e))),i.addEventListener("click",(e=>this.onCellClick(e))),this.boardEl.appendChild(i)}var t,a;this.cells=Array.from(this.boardEl.children)}redrawPositions(e){for(const e of this.cells)e.innerHTML="";for(const a of e){const e=this.boardEl.children[a.position],i=document.createElement("div");i.classList.add("character",a.character.type);const s=document.createElement("div");s.classList.add("health-level");const r=document.createElement("div");r.classList.add("health-level-indicator","health-level-indicator-"+((t=a.character.health)<15?"critical":t<50?"normal":"high")),r.style.width=`${a.character.health}%`,s.appendChild(r),i.appendChild(s),e.appendChild(i)}var t}addCellEnterListener(e){this.cellEnterListeners.push(e)}addCellLeaveListener(e){this.cellLeaveListeners.push(e)}addCellClickListener(e){this.cellClickListeners.push(e)}addNewGameListener(e){this.newGameListeners.push(e)}addSaveGameListener(e){this.saveGameListeners.push(e)}addLoadGameListener(e){this.loadGameListeners.push(e)}onCellEnter(e){e.preventDefault();const t=this.cells.indexOf(e.currentTarget);this.cellEnterListeners.forEach((e=>e.call(null,t)))}onCellLeave(e){e.preventDefault();const t=this.cells.indexOf(e.currentTarget);this.cellLeaveListeners.forEach((e=>e.call(null,t)))}onCellClick(e){const t=this.cells.indexOf(e.currentTarget);this.cellClickListeners.forEach((e=>e.call(null,t)))}onNewGameClick(e){e.preventDefault(),this.newGameListeners.forEach((e=>e.call(null)))}onSaveGameClick(e){e.preventDefault(),this.saveGameListeners.forEach((e=>e.call(null)))}onLoadGameClick(e){e.preventDefault(),this.loadGameListeners.forEach((e=>e.call(null)))}static showError(e){alert(e)}static showMessage(e){alert(e)}selectCell(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"yellow";this.deselectCell(e),this.cells[e].classList.add("selected",`selected-${t}`)}deselectCell(e){const t=this.cells[e];t.classList.remove(...Array.from(t.classList).filter((e=>e.startsWith("selected"))))}showCellTooltip(e,t){this.cells[t].title=e}hideCellTooltip(e){this.cells[e].title=""}showDamage(e,t){return new Promise((a=>{const i=this.cells[e],s=document.createElement("span");s.textContent=t,s.classList.add("damage"),i.appendChild(s),s.addEventListener("animationend",(()=>{i.removeChild(s),a()}))}))}setCursor(e){this.boardEl.style.cursor=e}checkBinding(){if(null===this.container)throw new Error("GamePlay not bind to DOM")}}const i={1:"prairie",2:"desert",3:"arctic",4:"mountain"};class s{constructor(){this.indexSelectedCell=null}static from(e){return null}}const r="auto",n="pointer",l="crosshair",c="not-allowed";class h{constructor(e){this.characters=e}}class o{constructor(e,t){if(this.level=e,this.attack=0,this.defence=0,this.health=50,this.type=t,"Character"===new.target.name)throw new Error("Нельзя создавать персонажа при помощи new Character()")}}class d{constructor(e,t){if(!(e instanceof o))throw new Error("character must be instance of Character or its children");if("number"!=typeof t)throw new Error("position must be a number");this.character=e,this.position=t}}class m extends o{constructor(e){super(e,"bowman"),this.attack=25,this.defence=25,this.distanceMovi=2,this.distanceAttack=2}}class g extends o{constructor(e){super(e,"daemon"),this.attack=10,this.defence=10,this.distanceMovi=1,this.distanceAttack=4}}class f extends o{constructor(e){super(e,"magician"),this.attack=10,this.defence=40,this.distanceMovi=1,this.distanceAttack=4}}class C extends o{constructor(e){super(e,"swordsman"),this.attack=40,this.defence=10,this.distanceMovi=4,this.distanceAttack=1}}class u extends o{constructor(e){super(e,"undead"),this.attack=40,this.defence=10,this.distanceMovi=4,this.distanceAttack=1}}class p extends o{constructor(e){super(e,"vampire"),this.attack=25,this.defence=25,this.distanceMovi=2,this.distanceAttack=2}}const S=new a;S.bindToDOM(document.querySelector("#game-container"));const k=new class{constructor(e){this.storage=e}save(e){this.storage.setItem("state",JSON.stringify(e))}load(){try{return JSON.parse(this.storage.getItem("state"))}catch(e){throw new Error("Invalid state")}}}(localStorage),v=new class{constructor(e,t){this.gamePlay=e,this.stateService=t}init(){this.gamePlay.addCellEnterListener(this.onCellEnter.bind(this)),this.gamePlay.addCellLeaveListener(this.onCellLeave.bind(this)),this.gamePlay.addCellClickListener(this.onCellClick.bind(this)),this.gamePlay.addNewGameListener(this.start.bind(this)),this.gamePlay.addSaveGameListener(this.saveGame.bind(this)),this.gamePlay.addLoadGameListener(this.loadGame.bind(this)),this.start()}saveGame(){this.stateService.save(this.gameState)}loadGame(){this.gameState=this.stateService.load(),this.gamePlay.drawUi(i[this.gameState.teme]),this.gamePlay.redrawPositions(this.gameState.positionedCharacter)}start(){0===this.gamePlay.cellClickListeners.length&&(this.gamePlay.addCellEnterListener(this.onCellEnter.bind(this)),this.gamePlay.addCellLeaveListener(this.onCellLeave.bind(this)),this.gamePlay.addCellClickListener(this.onCellClick.bind(this))),this.gameState=new s,this.gameState.teme=1,this.gamePlay.drawUi(i[this.gameState.teme]),this.goodTeam=this.formteam([m,C,f]),this.badTeam=this.formteam([g,u,p]),this.positionedCharacter()}newGame(){this.gameState.teme+=1,this.gamePlay.drawUi(i[this.gameState.teme]),this.goodTeam=this.formteam([m,C,f]),this.badTeam=this.formteam([g,u,p]),this.replacingPlayersSurvivors(),this.positionedCharacter(),this.gamePlay.redrawPositions(this.gameState.positionedCharacter),console.log("ok")}formteam(e){return function(e,t,a){const i=[],s=function*(e,t){for(;;){const a=Math.floor(Math.random()*t)+1,i=Math.floor(Math.random()*e.length);yield new e[i](a)}}(e,t);for(;a>1;)i.push(s.next().value),a-=1;return new h(i)}(e,3,this.gameState.teme+2)}formPositionsTeam(e,t,a){return e.characters.forEach((e=>{const i=e,s=Math.floor(Math.random()*t.length),r=t[s];t.splice(s,1),a.push(new d(i,r))})),a}async onCellClick(e){console.log("Кликнутая клетка",e);const t=this.findCharacterOnCellindex(e);t?this.definingСommand(t.character.type)?(this.medodDeselectCell(),this.gamePlay.selectCell(e),this.gameState.indexSelectedCell=e):null!==this.gameState.indexSelectedCell?this.afterClickingOnEnemy(e,t):a.showError("Это персонаж врага, вам нельзя им управлять!"):null!==this.gameState.indexSelectedCell&&this.characterMovements(e)}onCellEnter(e){const t=this.findCharacterOnCellindex(e);if(t){const a=this.formTooltip(t);this.gamePlay.showCellTooltip(a,e),this.definingСommand(t.character.type)?this.gamePlay.setCursor(n):this.сhangingCursorOnEnemy(e)}else this.gamePlay.setCursor(r),null!==this.gameState.indexSelectedCell&&this.highlightingCellsForStep(e)}onCellLeave(e){this.gamePlay.hideCellTooltip(e),this.gameState.indexSelectedCell!==e&&this.gamePlay.deselectCell(e)}positionedCharacter(){const e=[];for(let t=0;t<64;t++)t%8!=0&&(t-1)%8!=0||e.push(t);const t=[];for(let e=0;e<64;e++)(e+2)%8!=0&&(e+1)%8!=0||t.push(e);let a=[];a=this.formPositionsTeam(this.goodTeam,e,a),a=this.formPositionsTeam(this.badTeam,t,a),this.gamePlay.redrawPositions(a),this.gameState.positionedCharacter=a}findCharacterOnCellindex(e){return this.gameState.positionedCharacter.find((t=>t.position===e))}formTooltip(e){const{level:t,attack:a,defence:i,health:s}=e.character;return`🎖${t} ⚔${a} 🛡${i} ❤${s}`}definingСommand(e){return!!["bowman","swordsman","magician"].find((t=>t===e))}async attack(e,t){console.log("Здоровье врага",t.character.health);const a=Math.max(e.character.attack-t.character.defence,.1*e.character.attack);await this.gamePlay.showDamage(t.position,a),t.character.health-=a,this.gamePlay.redrawPositions(this.gameState.positionedCharacter),console.log("После удара здоровье врага",t.character.health)}checkLife(){for(let e=0;e<this.gameState.positionedCharacter.length;e++)this.gameState.positionedCharacter[e].character.health<=0&&(this.definingСommand(this.gameState.positionedCharacter[e].character.type)?this.medodDeselectCell():this.gamePlay.deselectCell(this.gameState.positionedCharacter[e].position),this.gameState.positionedCharacter.splice(e,1));this.gamePlay.redrawPositions(this.gameState.positionedCharacter)}checkLifeTeam(){let e=0,t=0;return this.gameState.positionedCharacter.forEach((a=>{this.definingСommand(a.character.type)?e+=1:t+=1})),console.log("Твоих игроков =",e,"  Игроков врага =",t),0===e?"Твоя команда проиграла":0===t?"Команда противника проиграла":void 0}addHealth(){this.gameState.positionedCharacter.forEach((e=>{e.character.health+=80,e.character.health>100&&(e.character.health=100)}))}addAttackDefence(){this.gameState.positionedCharacter.forEach((e=>{e.character.attack=Math.max(e.character.attack,e.character.attack*(80+e.character.health)/100),e.character.defence=Math.max(e.character.defence,e.character.defence*(80+e.character.health)/100)}))}blockBoard(){this.gamePlay.cellClickListeners=[],this.gamePlay.cellEnterListeners=[],this.gamePlay.cellLeaveListeners=[],this.gamePlay.setCursor(r)}async answerEnemy(){let e=!1;const a=[];this.gameState.positionedCharacter.forEach((e=>{this.definingСommand(e.character.type)&&a.push(e.position)}));for(let i=0;i<this.gameState.positionedCharacter.length;i++){const s=this.gameState.positionedCharacter[i];if(!this.definingСommand(s.character.type)){const r=t(s.position,s.character.distanceAttack);for(let t=0;t<r.length;t++){const n=r[t];if(a.find((e=>e===n))){const t=this.findCharacterOnCellindex(n);await this.attack(s,t),i=this.gameState.positionedCharacter.length,e=!0;break}}}}if(!e){for(let e=0;e<this.gameState.positionedCharacter.length;e++){const t=this.gameState.positionedCharacter[e];this.definingСommand(t.character.type)||(t.position-=1,e=this.gameState.positionedCharacter.length)}this.gamePlay.redrawPositions(this.gameState.positionedCharacter)}}medodDeselectCell(){null!==this.gameState.indexSelectedCell&&(this.gamePlay.deselectCell(this.gameState.indexSelectedCell),this.gameState.indexSelectedCell=null)}сhangingCursorOnEnemy(e){if(null!==this.gameState.indexSelectedCell){const a=this.findCharacterOnCellindex(this.gameState.indexSelectedCell);t(a.position,a.character.distanceAttack).find((t=>t===e))?(this.gamePlay.setCursor(l),this.gamePlay.selectCell(e,"red")):this.gamePlay.setCursor(c)}else this.gamePlay.setCursor(n)}highlightingCellsForStep(t){const a=this.findCharacterOnCellindex(this.gameState.indexSelectedCell);e(this.gameState.indexSelectedCell,a.character.distanceMovi).find((e=>e===t))?this.gamePlay.selectCell(t,"green"):this.gamePlay.setCursor(c)}async afterClickingOnEnemy(e,a){const i=this.findCharacterOnCellindex(this.gameState.indexSelectedCell);if(t(this.gameState.indexSelectedCell,i.character.distanceAttack).find((t=>t===e))){await this.attack(i,a),this.checkLife(),await this.answerEnemy(),this.checkLife();const e=this.checkLifeTeam();"Команда противника проиграла"===e&&(alert("Команда противника проиграла"),4===this.gameState.teme?this.blockBoard():(this.addAttackDefence(),this.addHealth(),this.medodDeselectCell(),this.newGame())),"Твоя команда проиграла"===e&&alert("Твоя команда проиграла")}}async characterMovements(t){const a=this.findCharacterOnCellindex(this.gameState.indexSelectedCell);if(e(this.gameState.indexSelectedCell,a.character.distanceMovi).find((e=>e===t))){const e=this.gameState.positionedCharacter.indexOf(a,0);this.gameState.positionedCharacter[e].position=t,this.gamePlay.redrawPositions(this.gameState.positionedCharacter),this.medodDeselectCell(),await this.answerEnemy(),this.checkLife()}}replacingPlayersSurvivors(){for(let e=0;e<this.gameState.positionedCharacter.length;e+=1)this.gameState.positionedCharacter[e].character&&(this.goodTeam.characters[e]=this.gameState.positionedCharacter[e].character,this.goodTeam.characters[e].level+=1)}}(S,k);v.init()})();